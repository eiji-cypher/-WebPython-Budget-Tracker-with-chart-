<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ’° Budget Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <style>
    body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
    .navbar { background: linear-gradient(135deg, #1a1a2e, #16213e); }
    .navbar-brand { font-weight: 700; font-size: 1.3rem; letter-spacing: .5px; }
    .card { border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,.08); }
    .card-header { border-radius: 16px 16px 0 0 !important; font-weight: 600; }
    .stat-card { border-left: 5px solid; transition: transform .2s; }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card.total  { border-color: #0d6efd; }
    .stat-card.count  { border-color: #198754; }
    .stat-card.avg    { border-color: #fd7e14; }
    .badge-category { font-size: .75rem; padding: .35em .7em; border-radius: 8px; }
    .table thead th { background: #1a1a2e; color: #fff; font-weight: 500; border: none; }
    .table tbody tr:hover { background: #eef2ff; }
    .btn-action { width: 32px; height: 32px; padding: 0; border-radius: 8px; display:inline-flex; align-items:center; justify-content:center; }
    .chart-img { border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.1); width: 100%; }
    .progress { height: 10px; border-radius: 8px; }
    .nav-tabs .nav-link.active { font-weight: 600; color: #0d6efd; }
    .filter-bar { background: #fff; border-radius: 16px; padding: 1rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark navbar-expand-lg mb-4 py-3">
  <div class="container">
    <a class="navbar-brand text-white" href="/">ðŸ’° Budget Tracker</a>
    <div class="d-flex gap-2">
      <a href="/" class="btn btn-sm {{ 'btn-light' if view != 'analytics' else 'btn-outline-light' }}">
        <i class="bi bi-list-ul me-1"></i>Expenses
      </a>
      <a href="/analytics" class="btn btn-sm {{ 'btn-light' if view == 'analytics' else 'btn-outline-light' }}">
        <i class="bi bi-bar-chart-fill me-1"></i>Analytics
      </a>
    </div>
  </div>
</nav>

<div class="container pb-5">

  <!-- FLASH MESSAGES -->
  {% for cat, msg in get_flashed_messages(with_categories=true) %}
  <div class="alert alert-{{ cat }} alert-dismissible fade show rounded-3 mb-3" role="alert">
    {{ msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXPENSES VIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if view != 'analytics' %}

  <!-- Stat Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card stat-card total p-3">
        <div class="text-muted small">Total Expenses</div>
        <div class="fw-bold fs-4 text-primary">â‚±{{ "{:,.2f}".format(total) }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card count p-3">
        <div class="text-muted small">Records</div>
        <div class="fw-bold fs-4 text-success">{{ expenses|length }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card avg p-3">
        <div class="text-muted small">Average per Record</div>
        <div class="fw-bold fs-4 text-warning">
          â‚±{{ "{:,.2f}".format(total / expenses|length) if expenses else "0.00" }}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- ADD EXPENSE FORM -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-plus-circle me-2"></i>Add Expense
        </div>
        <div class="card-body">
          <form action="/add" method="POST">
            <div class="mb-3">
              <label class="form-label fw-semibold">Amount (â‚±)</label>
              <input type="number" name="amount" class="form-control" step="0.01" min="0.01" placeholder="0.00" required/>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Category</label>
              <select name="category" class="form-select" required>
                {% for cat in categories %}
                <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Description</label>
              <input type="text" name="description" class="form-control" placeholder="e.g. Grocery run" required/>
            </div>
            <div class="mb-4">
              <label class="form-label fw-semibold">Date</label>
              <input type="date" name="date" class="form-control"/>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-plus-lg me-1"></i>Add Expense
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- EXPENSE LIST -->
    <div class="col-lg-8">
      <!-- Filter Bar -->
      <div class="filter-bar mb-3">
        <form method="GET" action="/" class="row g-2 align-items-end">
          <div class="col-md-5">
            <label class="form-label mb-1 fw-semibold small">Filter by Category</label>
            <select name="category" class="form-select form-select-sm">
              <option value="">All Categories</option>
              {% for cat in categories %}
              <option value="{{ cat }}" {{ 'selected' if selected_category == cat }}>{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1 fw-semibold small">Filter by Month</label>
            <input type="month" name="month" class="form-control form-control-sm" value="{{ selected_month }}"/>
          </div>
          <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm flex-fill">
              <i class="bi bi-funnel"></i> Filter
            </button>
            <a href="/" class="btn btn-outline-secondary btn-sm flex-fill">Clear</a>
          </div>
        </form>
      </div>

      <!-- Table -->
      <div class="card">
        <div class="card-body p-0">
          {% if expenses %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Category</th>
                  <th>Description</th>
                  <th class="text-end">Amount</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% set cat_colors = {
                  "Food": "success", "Transport": "info", "Housing": "dark",
                  "Health": "danger", "Entertainment": "warning", "Shopping": "primary",
                  "Education": "secondary", "Other": "light text-dark"
                } %}
                {% for exp in expenses|sort(attribute='date', reverse=True) %}
                <tr>
                  <td class="text-muted small">{{ exp.date }}</td>
                  <td>
                    <span class="badge bg-{{ cat_colors.get(exp.category, 'secondary') }} badge-category">
                      {{ exp.category }}
                    </span>
                  </td>
                  <td>{{ exp.description }}</td>
                  <td class="text-end fw-semibold text-primary">â‚±{{ "{:,.2f}".format(exp.amount) }}</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-outline-warning btn-action me-1"
                            onclick="openEdit('{{ exp.id }}','{{ exp.amount }}','{{ exp.category }}','{{ exp.description }}','{{ exp.date }}')"
                            title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <form action="/delete/{{ exp.id }}" method="POST" class="d-inline"
                          onsubmit="return confirm('Delete this expense?')">
                      <button type="submit" class="btn btn-sm btn-outline-danger btn-action" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="table-light fw-bold">
                  <td colspan="3" class="text-end">Total</td>
                  <td class="text-end text-primary">â‚±{{ "{:,.2f}".format(total) }}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <p class="mt-2">No expenses found. Add your first one!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANALYTICS VIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% else %}

  <!-- Month Filter -->
  <div class="filter-bar mb-4">
    <form method="GET" action="/analytics" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label fw-semibold small mb-1">Filter by Month</label>
        <input type="month" name="month" class="form-control form-control-sm" value="{{ selected_month }}"/>
      </div>
      <div class="col-auto d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-funnel"></i> Apply</button>
        <a href="/analytics" class="btn btn-outline-secondary btn-sm">Clear</a>
      </div>
    </form>
  </div>

  <!-- Summary Stats -->
  {% if summary %}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card stat-card total p-3">
        <div class="text-muted small">Total Spent</div>
        <div class="fw-bold fs-4 text-primary">â‚±{{ "{:,.2f}".format(summary.total) }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card count p-3">
        <div class="text-muted small">Transactions</div>
        <div class="fw-bold fs-4 text-success">{{ summary.count }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card avg p-3">
        <div class="text-muted small">Categories Used</div>
        <div class="fw-bold fs-4 text-warning">{{ summary.breakdown|length }}</div>
      </div>
    </div>
  </div>

  <!-- Category Breakdown -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white">
      <i class="bi bi-pie-chart me-2"></i>Category Breakdown
    </div>
    <div class="card-body">
      {% for item in summary.breakdown %}
      <div class="d-flex justify-content-between mb-1">
        <span class="fw-semibold">{{ item.category }}</span>
        <span class="text-muted">â‚±{{ "{:,.2f}".format(item.amount) }} ({{ item.percent }}%)</span>
      </div>
      <div class="progress mb-3">
        <div class="progress-bar bg-primary" style="width: {{ item.percent }}%"></div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-4">
    {% if pie_chart %}
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white"><i class="bi bi-pie-chart-fill me-2"></i>Spending by Category</div>
        <div class="card-body text-center">
          <img src="/{{ pie_chart }}?ts={{ ts }}" class="chart-img" alt="Pie Chart"/>
        </div>
      </div>
    </div>
    {% endif %}
    {% if line_chart %}
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white"><i class="bi bi-graph-up me-2"></i>Daily Trend</div>
        <div class="card-body text-center">
          <img src="/{{ line_chart }}?ts={{ ts }}" class="chart-img" alt="Line Chart"/>
        </div>
      </div>
    </div>
    {% endif %}
    {% if monthly_chart %}
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-dark text-white"><i class="bi bi-bar-chart-fill me-2"></i>Monthly Overview</div>
        <div class="card-body text-center">
          <img src="/{{ monthly_chart }}?ts={{ ts }}" class="chart-img" alt="Monthly Chart"/>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="text-center py-5 text-muted">
    <i class="bi bi-inbox fs-1"></i>
    <p class="mt-2">No expense data yet. Add some expenses first!</p>
  </div>
  {% endif %}

  {% endif %}
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header bg-warning">
        <h5 class="modal-title fw-bold"><i class="bi bi-pencil me-2"></i>Edit Expense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Amount (â‚±)</label>
            <input type="number" name="amount" id="editAmount" class="form-control" step="0.01" required/>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Category</label>
            <select name="category" id="editCategory" class="form-select">
              {% for cat in categories %}
              <option value="{{ cat }}">{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Description</label>
            <input type="text" name="description" id="editDescription" class="form-control" required/>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Date</label>
            <input type="date" name="date" id="editDate" class="form-control" required/>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning fw-bold"><i class="bi bi-check-lg me-1"></i>Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openEdit(id, amount, category, description, date) {
  document.getElementById("editForm").action = "/update/" + id;
  document.getElementById("editAmount").value = amount;
  document.getElementById("editCategory").value = category;
  document.getElementById("editDescription").value = description;
  document.getElementById("editDate").value = date;
  new bootstrap.Modal(document.getElementById("editModal")).show();
}
</script>
</body>
</html>
